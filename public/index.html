<!DOCTYPE html>
<html>

<head>
  <title>USD Viewer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, viewport-fit=cover" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="https://autodesk-forks.github.io/USD/ and @hybridherbst" />
  <meta property="og:url" content="https://usd-viewer.glitch.me/" />
  <meta property="og:title" content="USD Viewer" />
  <meta property="og:description" content="Simple USD Viewer based on Autodesk's USD WASM Fork" />
  <meta property="og:image"
    content="https://cdn.glitch.global/bee386a1-31e6-4710-8850-a1d5b7026a09/usd-viewer-preview2.webp?v=1646525510950" />

  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <script type="text/javascript" async src="modules/es-module-shims@1.8.0.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.163.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/"
      }
    }
  </script>
  <script type="module" src="https://unpkg.com/three@0.163.0/build/three.module.js"></script>
  <script type="module" src="index.js"></script>
  <script type="module">
    import { init } from './index.js';
    init();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <style>
    #qr-code-container {
      text-align: center;
      margin-right: 32px;
    }
  </style>
  <div id="container" style="position:absolute; margin:5px;">
    <a class="filename"></a>
    <br />
    <br />
  </div>

  <p id="message-log">
    Waiting for initialization to start...
  </p>
  </div>
  <div class="footer">
    <div id="qr-code-container">
      <h4>Model may not render or animate perfectly <br />on the web due to Apple usd standard</h4>
      <h5>Preview with <span style="color: crimson;">iPhone or iPad</span> to guarantee model display correctly</h5>
      <div id="qr-code"></div>
      <br />
      <div id="countdown"></div>
      <div id="preview-desc">
        <p>Scan QR then click this icon below in Safari</p>
        <img width="120" height="120" src="ARKit_Glyph.svg" title="ARKit Glyph" style="max-width:100%; height:auto;">
      </div>
    </div>
  </div>

  <script>
    // Extract the URL after the "?file=" parameter
    const fileUrl = decodeURIComponent(document.location.search.split("?file=")[1]);
    const urlParams = new URLSearchParams(new URL(fileUrl).search);
    let expiresInSeconds = parseInt(urlParams.get('X-Amz-Expires'), 10);
    if (isNaN(expiresInSeconds)) {
      let expires = urlParams.get('Expires');
      expires = parseInt(expires, 10);
      let currentTimestamp = Math.floor(Date.now() / 1000);
      if (expires) {
        expiresInSeconds = expires - currentTimestamp;
      }
    }
    console.log("expiresInSeconds", expiresInSeconds);

    // Calculate the expiration timestamp
    const currentTime = Math.floor(Date.now() / 1000);
    const expirationTimestamp = currentTime + expiresInSeconds;

    // Create QR Code
    const qrCode = new QRCodeStyling({
      width: 300,
      height: 300,
      data: fileUrl,
      image: "", // Optional: Add an image in the center of the QR code if needed
      // dotsOptions: {
      //   color: "#000",
      //   type: "rounded"
      // },
      backgroundOptions: {
        color: "#fff"
      }
    });

    qrCode.append(document.getElementById("qr-code"));

    // Function to update the countdown timer
    function updateCountdown() {
      const now = Math.floor(Date.now() / 1000);
      const remainingTime = expirationTimestamp - now;

      if (remainingTime <= 0) {
        document.getElementById('countdown').textContent = "Expired! Please click preview from Graffity Console again.";
        document.getElementById('qr-code').style.display = 'none';
        document.getElementById('preview-desc').style.display = 'none';
      } else {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        document.getElementById('countdown').textContent = `This preview will expire in ${minutes}m ${seconds}s`;
      }
    }

    // Update the countdown every second
    if (expiresInSeconds || !isNaN(expiresInSeconds)) {
      setInterval(updateCountdown, 1000);
    }

  </script>
</body>

</html>